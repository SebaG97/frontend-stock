<div class="container mx-auto p-4 sm:p-6">
  <!-- Header con título y acciones principales -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Órdenes de Trabajo</h1>
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
      <p-button 
        label="Nueva Orden" 
        icon="pi pi-plus" 
        severity="success"
        routerLink="/partes-trabajo/nuevo"
        class="w-full sm:w-auto">
      </p-button>
    </div>
  </div>

  <!-- Cards de resumen -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-6" *ngIf="resumen">
    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-blue-50">
          <i class="pi pi-file text-4xl text-blue-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600">{{ resumen.total_partes }}</div>
        <div class="text-sm text-gray-600">Total</div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-yellow-50">
          <i class="pi pi-clock text-4xl text-yellow-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-yellow-600">{{ resumen.partes_pendientes }}</div>
        <div class="text-sm text-gray-600">Pendientes</div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-orange-50">
          <i class="pi pi-cog text-4xl text-orange-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-orange-600">{{ resumen.partes_en_proceso }}</div>
        <div class="text-sm text-gray-600">En Progreso</div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-green-50">
          <i class="pi pi-check text-4xl text-green-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-green-600">{{ resumen.partes_finalizados }}</div>
        <div class="text-sm text-gray-600">Completados</div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-purple-50">
          <i class="pi pi-hourglass text-4xl text-purple-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-purple-600">{{ formatearHoras(resumen.total_horas_trabajadas) }}</div>
        <div class="text-sm text-gray-600">Horas Totales</div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="text-center p-3 bg-gray-50">
          <i class="pi pi-chart-bar text-4xl text-gray-500"></i>
        </div>
      </ng-template>
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-600">{{ formatearHoras(resumen.promedio_horas_por_parte) }}</div>
        <div class="text-sm text-gray-600">Promedio/Orden</div>
      </div>
    </p-card>
  </div>

  <!-- Filtros y búsqueda -->
  <p-card class="mb-4">
    <ng-template pTemplate="header">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold text-gray-900">Filtros y Búsqueda</h3>
      </div>
    </ng-template>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Búsqueda rápida -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-2">Búsqueda rápida</label>
        <div class="p-inputgroup">
          <input 
            type="text" 
            pInputText 
            placeholder="Buscar por descripción, cliente..." 
            [(ngModel)]="searchQuery"
            (keyup.enter)="buscar()"
            class="w-full">
          <p-button 
            icon="pi pi-search" 
            (onClick)="buscar()"
            severity="secondary">
          </p-button>
        </div>
      </div>

      <!-- Filtro por estado -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-2">Estado</label>
        <p-dropdown 
          [options]="estadosDisponibles" 
          [(ngModel)]="filtros.estado"
          (onChange)="aplicarFiltros()"
          placeholder="Todos los estados"
          [showClear]="true"
          class="w-full">
        </p-dropdown>
      </div>

      <!-- Filtro por cliente -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-2">Cliente</label>
        <input 
          type="text" 
          pInputText
          placeholder="Filtrar por cliente"
          [(ngModel)]="filtros.cliente_empresa"
          (keyup.enter)="aplicarFiltros()"
          class="w-full">
      </div>

      <!-- Filtro por fechas -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-2">Fecha desde</label>
        <p-calendar 
          [(ngModel)]="filtros.fecha_desde"
          (onSelect)="aplicarFiltros()"
          dateFormat="yy-mm-dd"
          placeholder="Seleccionar fecha"
          iconDisplay="input"
          class="w-full">
        </p-calendar>
      </div>
    </div>

    <div class="flex justify-end mt-4">
      <p-button 
        label="Limpiar Filtros" 
        icon="pi pi-times" 
        severity="secondary"
        (onClick)="limpiarFiltros()"
        class="mr-2">
      </p-button>
    </div>
  </p-card>

  <!-- Mensaje de error -->
  <div class="p-4 mb-4 bg-red-100 border border-red-400 text-red-700 rounded" *ngIf="error">
    {{ error }}
  </div>

  <!-- Loading spinner -->
  <div class="flex justify-center items-center py-8" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Tabla de órdenes de trabajo -->
  <p-card *ngIf="!loading">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center p-4 border-b">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Lista de Órdenes de Trabajo</h3>
          <p class="text-sm text-gray-600">{{ totalItems }} órdenes encontradas</p>
        </div>
      </div>
    </ng-template>

    <p-table 
      [value]="partesTrabajo" 
      [paginator]="true" 
      [rows]="10"
      [totalRecords]="totalItems"
      [loading]="loading"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-gridlines"
      [scrollable]="true"
      [responsive]="true">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="numero">
            ID 
            <p-sortIcon field="numero"></p-sortIcon>
          </th>
          <th>Cliente</th>
          <th>Técnicos</th>
          <th pSortableColumn="trabajo_solicitado">
            Trabajo Solicitado 
            <p-sortIcon field="trabajo_solicitado"></p-sortIcon>
          </th>
          <th pSortableColumn="fecha">
            Fecha 
            <p-sortIcon field="fecha"></p-sortIcon>
          </th>
          <th pSortableColumn="estado">
            Estado 
            <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th>Horario</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-parte>
        <tr>
          <td>
            <p-tag 
              [value]="'#' + parte.numero" 
              severity="secondary">
            </p-tag>
            <div class="text-xs text-gray-500 mt-1" *ngIf="parte.id_parte_api">
              API: {{ parte.id_parte_api }}
            </div>
          </td>
          <td>
            <div class="font-medium">{{ parte.cliente_empresa || 'Sin empresa' }}</div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <div *ngFor="let tecnico of parte.tecnicos" class="flex items-center gap-2">
                <i class="pi pi-user text-blue-500 text-xs"></i>
                <span class="text-sm">{{ tecnico.nombre }}</span>
              </div>
              <div *ngIf="parte.tecnicos.length === 0" class="text-gray-500 italic text-sm">
                Sin asignar
              </div>
            </div>
          </td>
          <td>
            <div class="max-w-48 overflow-hidden">
              <div class="font-medium truncate" [title]="parte.trabajo_solicitado">
                {{ parte.trabajo_solicitado }}
              </div>
            </div>
          </td>
          <td>
            <div class="text-sm">
              {{ formatearFecha(parte.fecha) }}
            </div>
          </td>
          <td>
            <p-tag 
              [value]="formatearEstado(parte.estado)"
              [severity]="getSeverityFromEstado(parte.estado)">
            </p-tag>
          </td>
          <td>
            <div class="text-sm space-y-1">
              <div class="flex items-center gap-2">
                <i class="pi pi-clock text-blue-500"></i>
                <span *ngIf="parte.hora_ini">{{ parte.hora_ini }}</span>
                <span *ngIf="!parte.hora_ini">--:--</span>
              </div>
              <div class="flex items-center gap-2" *ngIf="parte.hora_fin">
                <i class="pi pi-stop-circle text-red-500"></i>
                <span>{{ parte.hora_fin }}</span>
              </div>
            </div>
          </td>
          <td>
            <div class="flex gap-1">
              <p-button 
                icon="pi pi-eye" 
                size="small"
                severity="info"
                [text]="true"
                (onClick)="verDetalle(parte)"
                pTooltip="Ver detalle">
              </p-button>
              <p-button 
                icon="pi pi-pencil" 
                size="small"
                severity="secondary"
                [text]="true"
                (onClick)="editarParte(parte)"
                pTooltip="Editar">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                size="small"
                severity="danger"
                [text]="true"
                (onClick)="eliminarParte(parte)"
                pTooltip="Eliminar">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-8">
            <div class="text-gray-500">
              <i class="pi pi-info-circle text-4xl mb-4 block"></i>
              <p>No se encontraron órdenes de trabajo</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
